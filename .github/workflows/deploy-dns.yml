name: Deploy DNS
on:
  workflow_run:
    workflows: ["DNS Checks"]
    branches: [main]
    types:
      - completed

jobs:
  deploy-test:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      actions: read
      contents: read
    runs-on: ubuntu-latest
    steps:
      - name: Download tfplan text artifact from triggering run
        uses: actions/download-artifact@v4
        with:
          name: tfplan-dns-text
          run-id: ${{ github.event.workflow_run.id }}
          path: .
      - name: Print plan
        run: |
          echo "--- Begin OpenTofu plan (dns) ---"
          if [ -f tfplan-dns.txt ]; then
            # Truncate to keep logs readable if extremely large
            LIMIT=200000
            SIZE=$(wc -c < tfplan-dns.txt | tr -d ' ')
            if [ "$SIZE" -gt "$LIMIT" ]; then
              head -c "$LIMIT" tfplan-dns.txt
              echo
              echo "... (truncated)"
            else
              cat tfplan-dns.txt
            fi
          else
            echo "Plan text file not found at tfplan-dns.txt"
          fi
          echo "--- End OpenTofu plan (dns) ---"
      
  # deploy:
  #   uses: ./.github/workflows/tofu.yml
  #   with:
  #     stack: "dns"
  #     action: "deploy"
  #     env: "production"
  #   secrets: inherit