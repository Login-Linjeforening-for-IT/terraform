name: Code checks
on:
  workflow_call:
    inputs:
      stack:
        required: true
        type: string
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      DIGITALOCEAN_TOKEN:
      
jobs:
  validate:
    uses: ./.github/workflows/tofu.yml
    secrets: inherit
    with:
      stack: ${{ inputs.stack }}
      action: "validate"
      env: "development"
  fmt:
    uses: ./.github/workflows/tofu.yml
    secrets: inherit
    with:
      stack: ${{ inputs.stack }}
      action: "fmt"
      env: "development"
  plan:
    needs: [validate, fmt]
    uses: ./.github/workflows/tofu.yml
    secrets: inherit
    with:
      stack: ${{ inputs.stack }}
      action: "plan"
      env: "development"
  comment:
    needs: [plan]
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Download plan text artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ inputs.stack }}-text
          path: plan_artifacts
      - name: Build PR comment body
        id: prep_comment
        run: |
          set -euo pipefail
          STACK='${{ inputs.stack }}'
          PLAN_FILE=$(find plan_artifacts -type f -name "tfplan-*.txt" | head -n1)
          if [ -z "${PLAN_FILE:-}" ] || [ ! -f "$PLAN_FILE" ]; then
            echo "Plan file not found in artifact" >&2
            exit 1
          fi
          echo "## OpenTofu plan (${STACK})" > comment.md
          echo "" >> comment.md
          echo "<details>" >> comment.md
          echo "<summary>Show plan</summary>" >> comment.md
          echo "" >> comment.md
          echo '```terraform' >> comment.md
          SIZE=$(wc -c < "$PLAN_FILE" | tr -d ' ')
          LIMIT=60000
          if [ "$SIZE" -gt "$LIMIT" ]; then
            head -c "$LIMIT" "$PLAN_FILE" >> comment.md
            echo "" >> comment.md
            echo "... (truncated)" >> comment.md
          else
            cat "$PLAN_FILE" >> comment.md
          fi
          echo '```' >> comment.md
          echo "" >> comment.md
          echo "</details>" >> comment.md
          {
            echo 'message<<EOF'
            cat comment.md
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"
      - name: Post plan as PR comment
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: ${{ steps.prep_comment.outputs.message }}